#!/usr/bin/env bash

set -e

all_views=(
  js-yaml.json

  libyaml.events
  libyaml.yaml

  nimyaml.tokens

  perl-yaml-pegex.events

  perl-yaml-pm.dumper
  perl-yaml-syck.dumper
  perl-yaml-tiny.dumper
  perl-yaml-xs.dumper
)

main() {
  file=input.yaml
  uid=$(stat -c%u $0)
  gid=$(stat -c%g $0)

  if [[ ! -e /.dockerenv ]]; then
    docker-run "$@"
  elif [[ $1 == RUN ]]; then
    "run-all"
  elif [[ $1 == TESTML ]]; then
    "show-tml"
  elif [[ $1 == SAVE ]]; then
    "save-tml"
  else
    "editor-start" "$@"
  fi
}

docker-run() {
  root=$(cd "$(dirname "$0")/.."; pwd)
  work=$(mktemp -d)
  mount_suite=''
  if [[ -n $YAML_TEST_SUITE ]]; then
    [[ -e $YAML_TEST_SUITE/test/229Q.tml ]] ||
      die "YAML_TEST_SUITE='$YAML_TEST_SUITE' seems to be invalid"
    mount_suite="-v $YAML_TEST_SUITE/test:/suite"
  fi

  docker run --rm -it \
    -v "$work":/yaml \
    -v "$root":/yaml-editor \
    $mount_suite \
    yamlio/yaml-editor \
    yaml-editor "$@"

  echo "Files saved in '$work'"
}

editor-start() {
  views=()
  regex=$1
  if [[ -n $regex ]]; then
    for view in ${all_views[@]}; do
      if [[ $view =~ $regex ]]; then
        views+=($view)
      fi
    done
    [[ ${#views[@]} -gt 0 ]] ||
      die "No views match '$regex'"
  else
    views=("${all_views[@]}")
  fi
  export YAML_EDITOR_VIEWS="${views[*]}"

  touch $file
  cp /yaml-editor/share/vimrc .vimrc
  cp /yaml-editor/share/help help

  for view in "${views[@]}"; do
    touch $view
  done

  chown -R "$uid.$gid" .

  if [[ -z $regex ]]; then
    vim -c 'source .vimrc' -c 'vsplit help' -c 'sbuffer input.yaml' $file
  else
    vim -c 'source .vimrc' -c 'sbuffer input.yaml' $file ${views[@]} -O
  fi
}

run-all() {
  for view in $YAML_EDITOR_VIEWS; do
    filter="${view/\./-}"
    cat $file | $filter &> $view || true
  done
}

save-tml() {
  local dir=
  [[ -e /suite ]] && dir=/suite || dir=.
  while true; do
    id="$(
      cat /dev/urandom |
      LC_ALL=C tr -cd A-HJ-NP-Z2-9 |
      fold -w4 |
      grep [A-Z] |
      grep [0-9] |
      head -n1
    )"
    file="$dir/$id.tml"
    [[ -e "$file" ]] || break
  done

  make-tml
  echo "$tml" > $file
  chown "$uid.$gid" $file
  echo $file
}

show-tml() {
  make-tml
  echo "$tml" > TEST.tml
  echo TEST.tml
}

make-tml() {
  tml="\
=== <label goes here>
from: <Source URL or description>
tags: <tag,words,separated,by,commas>

+++ in-yaml
$(tml input.yaml)
"
  libyaml=$(tml libyaml.events)
  if [[ $libyaml =~ (^|$'\n')[^\+\-\=] ]]; then
    tml+="
+++ error
"
  else
    tml+="
+++ out-yaml
$(tml libyaml.yaml)

+++ in-json
$(tml js-yaml.json)

+++ test-event
$(tml libyaml.events)
"
  fi
}

tml() {
  file=$1
  cat $1 | perl -pe 's/^(\s+$|%|#)/\\$1/'
}

die() {
  echo "$*" >&2
  exit 1
}

[[ $0 != "$BASH_SOURCE" ]] || main "$@"
